name: CI

on: [push, pull_request]

jobs:
  test:
    name: Test (Node ${{ matrix.node }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node: [8, 10, 12, 13]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v1

      - name: Use Node ${{ matrix.node }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      - name: Install NPM dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test
        env:
          CI: true

      - name: Run integration tests
        run: npm run integrate
        env:
          CI: true

  prettier:
    name: Format Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v1

      - name: Use Node12
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Install NPM dependencies
        run: npm ci

      - name: Format iles
        run: npm run format

      - name: Show git working tree
        run: git status

      - name: Commit formatted files on branch
        run: |
          git config --local user.email "ben@benmvp.com"
          git config --local user.name "Automated Formatter"
          git add -A
          # Do nothing if there are no changes
          git diff-index --quiet HEAD || git commit -m "Automated format of files"

      - name: Push data to repo
        uses: ad-m/github-push-action@v0.5.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
